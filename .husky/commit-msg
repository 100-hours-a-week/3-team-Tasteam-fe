#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

COMMIT_MESSAGE_FILE="$1"

if [ ! -s "$COMMIT_MESSAGE_FILE" ]; then
  exit 0
fi

first_line=$(sed -n '1p' "$COMMIT_MESSAGE_FILE")
remaining_lines=$(tail -n +2 "$COMMIT_MESSAGE_FILE")

# ì»¤ë°‹ ê¸°ì—¬ìž(Co-authored-by) íŠ¸ë ˆì¼ëŸ¬ ì—„ê²© ì°¨ë‹¨
if grep -Eiq '(co-authored-by|co-committed-by):[[:space:]]*' "$COMMIT_MESSAGE_FILE"; then
  echo "â›” ì»¤ë°‹ ê¸°ì—¬ìž(Co-authored-by) íŠ¸ë ˆì¼ëŸ¬ê°€ í¬í•¨ë˜ì–´ ìžˆì–´ ì»¤ë°‹ì„ ì°¨ë‹¨í–ˆìŠµë‹ˆë‹¤."
  echo "   ëª¨ë“  ì»¤ë°‹ì€ ë‹¨ë… ìž‘ì„±ìžë§Œ í—ˆìš©ë©ë‹ˆë‹¤."
  echo "   AI ë„êµ¬ì˜ ë„ì›€ì„ ë°›ì•„ ì»¤ë°‹ ë©”ì‹œì§€ë¥¼ ìž‘ì„±í•˜ì§€ ë§ˆì„¸ìš”."
  exit 1
fi

# AI ìƒì„± ì½˜í…ì¸  í‘œì‹œ ì°¨ë‹¨
if grep -Eiq '(claude|sonnet|anthropic|generated with|ðŸ¤– generated)' "$COMMIT_MESSAGE_FILE"; then
  echo "â›” AI ë„êµ¬ ê´€ë ¨ ë¬¸êµ¬ê°€ ì»¤ë°‹ ë©”ì‹œì§€ì— í¬í•¨ë˜ì–´ ìžˆì–´ ì°¨ë‹¨í–ˆìŠµë‹ˆë‹¤."
  echo "   ì»¤ë°‹ ë©”ì‹œì§€ëŠ” ê°œë°œìžê°€ ì§ì ‘ ìž‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤."
  echo "   Claude, ChatGPT ë“± AIì˜ ë„ì›€ì„ ë°›ì§€ ë§ˆì„¸ìš”."
  exit 1
fi

# ë¯¸ë¦¬ ì´ëª¨ì§€+íƒ€ìž…ì´ í¬í•¨ëœ ë©”ì‹œì§€ì´ë©´ ìƒëžµ
case "$first_line" in
  "âœ¨ feat"*)      exit 0 ;;
  "ðŸ› fix"*)       exit 0 ;;
  "âš¡ï¸ perf"*)      exit 0 ;;
  "â™»ï¸ refactor"*)  exit 0 ;;
  "âœ… test"*)      exit 0 ;;
  "ðŸ“ docs"*)      exit 0 ;;
  "ðŸ’„ style"*)     exit 0 ;;
  "ðŸ”§ chore"*)     exit 0 ;;
  "ðŸ” ci"*)        exit 0 ;;
  "ðŸ“¦ build"*)     exit 0 ;;
  "âª revert"*)    exit 0 ;;
esac

# Merge/Amend/Reset/Tag ë©”ì‹œì§€ëŠ” ìžì—°ìŠ¤ëŸ½ê²Œ í†µê³¼
case "$first_line" in
  Merge*|Revert*|Amend*|Reset*|Rebase*|Tag*)
    exit 0
    ;;
esac

type=$(echo "$first_line" | grep -o "^[A-Za-z]*")
normalized_type=$(echo "$type" | tr 'A-Z' 'a-z')

emoji=""
case "$normalized_type" in
  feat)     emoji="âœ¨" ;;
  fix)      emoji="ðŸ›" ;;
  perf)     emoji="âš¡ï¸" ;;
  refactor) emoji="â™»ï¸" ;;
  test)     emoji="âœ…" ;;
  docs)     emoji="ðŸ“" ;;
  style)    emoji="ðŸ’„" ;;
  chore)    emoji="ðŸ”§" ;;
  ci)       emoji="ðŸ”" ;;
  build)    emoji="ðŸ“¦" ;;
  revert)   emoji="âª" ;;
esac

if [ -z "$emoji" ] || [ -z "$normalized_type" ]; then
  echo "â›” ì»¤ë°‹ ë©”ì‹œì§€ íƒ€ìž…ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."
  echo "   https://github.com/team3/tasteam/tree/main/docs/convention/ì»¤ë°‹%20ë¸Œëžœì¹˜%20ì „ëžµ/ë¸Œëžœì¹˜_ì»¤ë°‹_ì „ëžµ.md ë¥¼ ì°¸ê³ í•˜ì„¸ìš”."
  echo "   ì‚¬ìš© ê°€ëŠ¥í•œ íƒ€ìž…: feat, fix, perf, refactor, test, docs, style, chore, ci, build, revert"
  exit 1
fi

formatted_first_line=$(echo "$first_line" | sed "s/^$type/$emoji $normalized_type/")

{
  echo "$formatted_first_line"
  echo "$remaining_lines"
} > "$COMMIT_MESSAGE_FILE"
