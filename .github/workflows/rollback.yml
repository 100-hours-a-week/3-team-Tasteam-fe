name: Frontend Rollback

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'ë¡¤ë°±í•  í™˜ê²½'
        required: true
        type: choice
        options:
          - develop
          - main
      run_number:
        description: 'ë¡¤ë°±í•  Run Number'
        required: true
        type: string

jobs:
  rollback:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment == 'main' && 'production' || 'development' }}
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. GitHub CLIë¥¼ ì´ìš©í•´ run_numberì— í•´ë‹¹í•˜ëŠ” ì‹¤ì œ run-idë¥¼ ì°¾ìŠµë‹ˆë‹¤.
      - name: Find Run ID
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ì§€ì •í•œ ë¸Œëœì¹˜ì™€ run_numberì— ë§ëŠ” run-id ì°¾ê¸°
          RUN_ID=$(gh run list \
            --workflow "Frontend CD" \
            --json databaseId,number,headBranch \
            --jq ".[] | select(.number == ${{ inputs.run_number }} and .headBranch == \"${{ inputs.environment }}\") | .databaseId" \
            | head -n 1)

          if [ -z "$RUN_ID" ]; then
            echo "âŒ Error: ${{ inputs.environment }} ë¸Œëœì¹˜ì˜ Run Number ${{ inputs.run_number }}ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            echo ""
            echo "ì‚¬ìš© ê°€ëŠ¥í•œ ìµœê·¼ ë¹Œë“œ ëª©ë¡:"
            gh run list --workflow "Frontend CD" --branch "${{ inputs.environment }}" --limit 10
            exit 1
          fi

          echo "FOUND_RUN_ID=$RUN_ID" >> $GITHUB_ENV
          echo "âœ… ì°¾ì€ Run ID: $RUN_ID (Run Number: ${{ inputs.run_number }}, Branch: ${{ inputs.environment }})"

      # 2. ì°¾ì€ Run IDë¥¼ ì‚¬ìš©í•˜ì—¬ ì•„í‹°íŒ©íŠ¸ë¥¼ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: fe-${{ inputs.environment }}-${{ inputs.run_number }}
          run-id: ${{ env.FOUND_RUN_ID }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path: ./rollback-temp

      # 3. ë‹¤ìš´ë¡œë“œí•œ ë²„ì „ ì •ë³´ í™•ì¸
      - name: Show Version Info
        run: |
          echo "=== Rollback Version Info ==="
          if [ -f ./rollback-temp/version.txt ]; then
            cat ./rollback-temp/version.txt
          else
            echo "version.txt not found"
          fi
          echo ""
          echo "=== Downloaded Files ==="
          ls -la ./rollback-temp/

      # 4. ì„œë²„ë¡œ íŒŒì¼ ì „ì†¡
      - name: Transfer to Server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          source: "./rollback-temp/*"
          target: "/home/${{ secrets.USERNAME }}/frontend/rollback"
          strip_components: 1

      # 5. ë¡¤ë°± ì‹¤í–‰
      - name: Deploy Rollback
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          script: |
            ROLLBACK_DIR="/home/${{ secrets.USERNAME }}/frontend/rollback"
            WEB_ROOT="/var/www/html"

            # í˜„ì¬ ë°°í¬ëœ ë²„ì „ ë°±ì—… ìƒì„±
            BACKUP_DIR="/home/${{ secrets.USERNAME }}/frontend/backup-$(date +%Y%m%d-%H%M%S)"
            mkdir -p $BACKUP_DIR
            if [ "$(ls -A $WEB_ROOT)" ]; then
              cp -r $WEB_ROOT/* $BACKUP_DIR/
              echo "âœ… í˜„ì¬ ë²„ì „ ë°±ì—… ì™„ë£Œ: $BACKUP_DIR"
            else
              echo "âš ï¸  ë°°í¬ëœ íŒŒì¼ì´ ì—†ì–´ ë°±ì—…ì„ ê±´ë„ˆëœë‹ˆë‹¤."
            fi

            # ë¡¤ë°± ì‹¤í–‰
            echo "ğŸ”„ ë¡¤ë°± ì‹œì‘..."
            rm -rf $WEB_ROOT/*
            cp -r $ROLLBACK_DIR/* $WEB_ROOT/

            # ì •ë¦¬
            rm -rf $ROLLBACK_DIR/*

            echo "âœ… ë¡¤ë°± ì™„ë£Œ!"
            if [ -f $WEB_ROOT/version.txt ]; then
              echo ""
              echo "=== ë°°í¬ëœ ë²„ì „ ì •ë³´ ==="
              cat $WEB_ROOT/version.txt
            fi

      # 6. ë¡¤ë°± ê²°ê³¼ ì•Œë¦¼
      - name: Notify Rollback Result
        if: always()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "í”„ë¡ íŠ¸ì—”ë“œ ${{ inputs.environment == 'main' && 'ìš´ì˜' || 'ê°œë°œ' }} ì„œë²„ ë¡¤ë°± ${{ job.status == 'success' && 'ì„±ê³µ âœ…' || 'ì‹¤íŒ¨ âŒ' }}"
          description: |
            **ê²°ê³¼:** ${{ job.status }}
            **í™˜ê²½:** ${{ inputs.environment == 'main' && 'ìš´ì˜' || 'ê°œë°œ' }}
            **ë¡¤ë°± ëŒ€ìƒ Run Number:** ${{ inputs.run_number }}
            **ì‹¤í–‰ì:** ${{ github.actor }}
          color: ${{ job.status == 'success' && '0x00ff00' || '0xff0000' }}
