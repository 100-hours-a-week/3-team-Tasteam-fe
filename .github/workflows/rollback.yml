name: Frontend Rollback

on:
  workflow_dispatch:
    inputs:
      environment:
        description: '롤백할 환경'
        required: true
        type: choice
        options:
          - develop
          - main
      run_number:
        description: '롤백할 Run Number'
        required: true
        type: string

jobs:
  rollback:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment == 'main' && 'production' || 'development' }}
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. GitHub CLI를 이용해 run_number에 해당하는 실제 run-id를 찾습니다.
      - name: Find Run ID
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 지정한 브랜치와 run_number에 맞는 run-id 찾기
          RUN_ID=$(gh run list \
            --workflow "Frontend CD" \
            --json databaseId,number,headBranch \
            --jq ".[] | select(.number == ${{ inputs.run_number }} and .headBranch == \"${{ inputs.environment }}\") | .databaseId" \
            | head -n 1)

          if [ -z "$RUN_ID" ]; then
            echo "❌ Error: ${{ inputs.environment }} 브랜치의 Run Number ${{ inputs.run_number }}를 찾을 수 없습니다."
            echo ""
            echo "사용 가능한 최근 빌드 목록:"
            gh run list --workflow "Frontend CD" --branch "${{ inputs.environment }}" --limit 10
            exit 1
          fi

          echo "FOUND_RUN_ID=$RUN_ID" >> $GITHUB_ENV
          echo "✅ 찾은 Run ID: $RUN_ID (Run Number: ${{ inputs.run_number }}, Branch: ${{ inputs.environment }})"

      # 2. 찾은 Run ID를 사용하여 아티팩트를 다운로드합니다.
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: fe-${{ inputs.environment }}-${{ inputs.run_number }}
          run-id: ${{ env.FOUND_RUN_ID }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path: ./rollback-temp

      # 3. 다운로드한 버전 정보 확인
      - name: Show Version Info
        run: |
          echo "=== Rollback Version Info ==="
          if [ -f ./rollback-temp/version.txt ]; then
            cat ./rollback-temp/version.txt
          else
            echo "version.txt not found"
          fi
          echo ""
          echo "=== Downloaded Files ==="
          ls -la ./rollback-temp/

      # 4. 롤백 대상 아티팩트를 staging 디렉토리로 업로드 (고유 경로)
      - name: Upload Rollback Files to Staging
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          source: "./rollback-temp/*"
          target: "/home/${{ secrets.USERNAME }}/frontend/staging/rollback/${{ inputs.environment }}/${{ inputs.run_number }}"
          strip_components: 1

      # 5. staging -> 새 release 생성 후 current 링크 전환
      - name: Promote Rollback Release
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          script: |
            set -euo pipefail

            STAGING_DIR="/home/${{ secrets.USERNAME }}/frontend/staging/rollback/${{ inputs.environment }}/${{ inputs.run_number }}"
            DEPLOY_BASE="/opt/caddy/www/html"
            RELEASES_DIR="${DEPLOY_BASE}/releases"
            CURRENT_LINK="${DEPLOY_BASE}/current"
            ROLLBACK_STAMP="$(date +%Y%m%d-%H%M%S)"
            RELEASE_ID="rollback-${{ inputs.environment }}-${{ inputs.run_number }}-${ROLLBACK_STAMP}"
            RELEASE_DIR="${RELEASES_DIR}/${RELEASE_ID}"
            # Use a relative symlink target so Caddy can resolve it inside the
            # container mount path (/var/www/html), not just on the host path.
            RELEASE_LINK_TARGET="releases/${RELEASE_ID}"
            TMP_LINK="${DEPLOY_BASE}/.current_tmp"

            if [ ! -d "$STAGING_DIR" ]; then
              echo "❌ Staging directory not found: $STAGING_DIR"
              exit 1
            fi

            sudo mkdir -p "$RELEASES_DIR"
            sudo mkdir -p "$RELEASE_DIR"
            sudo cp -a "$STAGING_DIR"/. "$RELEASE_DIR"/

            sudo rm -f "$TMP_LINK"
            sudo ln -s "$RELEASE_LINK_TARGET" "$TMP_LINK"
            sudo mv -Tf "$TMP_LINK" "$CURRENT_LINK"

            rm -rf "$STAGING_DIR"

            # 최근 5개 릴리즈만 유지
            (sudo ls -1dt "$RELEASES_DIR"/* 2>/dev/null || true) | tail -n +6 | xargs -r sudo rm -rf

            echo "✅ 롤백 완료! Current -> $(readlink "$CURRENT_LINK")"
            if [ -f "$CURRENT_LINK/version.txt" ]; then
              echo ""
              echo "=== 배포된 버전 정보 ==="
              cat "$CURRENT_LINK/version.txt"
            fi

      # 6. 실패/중단 포함 staging 잔여물 정리
      - name: Cleanup Rollback Staging Directory
        if: always()
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          script: |
            rm -rf "/home/${{ secrets.USERNAME }}/frontend/staging/rollback/${{ inputs.environment }}/${{ inputs.run_number }}"

      # 7. 롤백 결과 알림
      - name: Notify Rollback Result
        if: always()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "프론트엔드 ${{ inputs.environment == 'main' && '운영' || '개발' }} 서버 롤백 ${{ job.status == 'success' && '성공 ✅' || '실패 ❌' }}"
          description: |
            **결과:** ${{ job.status }}
            **환경:** ${{ inputs.environment == 'main' && '운영' || '개발' }}
            **롤백 대상 Run Number:** ${{ inputs.run_number }}
            **실행자:** ${{ github.actor }}
          color: ${{ job.status == 'success' && '0x00ff00' || '0xff0000' }}
