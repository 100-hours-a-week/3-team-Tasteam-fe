name: Frontend CD

on:
  push:
    branches:
      - develop
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: ${{ github.ref_name == 'main' && 'production' || 'development' }}

    steps:
      # 1. ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout source code
        uses: actions/checkout@v4

      # 2. Node.js ì„¤ì •
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      # 3. ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies
        run: npm ci

      # 4. í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„±
      - name: Create .env file
        run: echo "${{ secrets.ENV_FILE }}" > .env

      # 5. ë¹Œë“œ
      - name: Build
        run: npm run build

      - name: Write version metadata
        run: |
          cat > dist/version.txt <<EOF
          branch=${{ github.ref_name }}
          run_number=${{ github.run_number }}
          sha=${{ github.sha }}
          deployed_at_utc=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          EOF

      # 6. ë¹Œë“œ ì‚°ì¶œë¬¼ ì—…ë¡œë“œ (run_number ê¸°ë°˜ - ë¡¤ë°±ìš©)
      - name: Upload Build Artifact (with run number)
        uses: actions/upload-artifact@v4
        with:
          name: fe-${{ github.ref_name }}-${{ github.run_number }}
          path: dist/
          retention-days: 7

      # 7. ë¹Œë“œ ìš”ì•½
      - name: Build Summary
        run: |
          echo "### Build Success :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.ref_name == 'main' && 'ìš´ì˜' || 'ê°œë°œ' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Artifact Name:** \`fe-${{ github.ref_name }}-${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Run Number:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "You can rollback to this version using the Rollback workflow." >> $GITHUB_STEP_SUMMARY

      # 8. ë¹Œë“œ ì‹¤íŒ¨ ì•Œë¦¼
      - name: Notify Build Failure
        if: failure()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "í”„ë¡ íŠ¸ì—”ë“œ ${{ github.ref_name == 'main' && 'ìš´ì˜' || 'ê°œë°œ' }} ì„œë²„ ë¹Œë“œ ì‹¤íŒ¨ ğŸ’”"
          description: |
            **ê²°ê³¼:** ë¹Œë“œ ì‹¤íŒ¨
            **ë¸Œëœì¹˜:** ${{ github.ref_name }}
            **Run Number:** ${{ github.run_number }}
            **ì‘ì„±ì:** ${{ github.actor }}
            **ì»¤ë°‹:** ${{ github.sha }}
          color: 0xff0000

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name == 'main' && 'production' || 'development' }}
    timeout-minutes: 20

    steps:
      # 1. ë¹Œë“œ ì‚°ì¶œë¬¼ ë‹¤ìš´ë¡œë“œ
      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: fe-${{ github.ref_name }}-${{ github.run_number }}
          path: ./deploy-temp

      # 2. ì„œë²„ë¡œ ë¹Œë“œ ì‚°ì¶œë¬¼ ì—…ë¡œë“œ (ê³ ìœ  staging ê²½ë¡œ)
      - name: Upload Build Files to Staging
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          source: "./deploy-temp/*"
          target: "/home/${{ secrets.USERNAME }}/frontend/staging/${{ github.ref_name }}/${{ github.run_number }}"
          strip_components: 1

      # 3. ìƒˆ release ìƒì„± í›„ current ì‹¬ë³¼ë¦­ ë§í¬ ì „í™˜ (atomic)
      - name: Promote Staging to Release
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          script: |
            set -euo pipefail

            STAGING_DIR="/home/${{ secrets.USERNAME }}/frontend/staging/${{ github.ref_name }}/${{ github.run_number }}"
            DEPLOY_BASE="/opt/caddy/www/html"
            RELEASES_DIR="${DEPLOY_BASE}/releases"
            CURRENT_LINK="${DEPLOY_BASE}/current"
            SHORT_SHA="$(printf '%s' '${{ github.sha }}' | cut -c1-12)"
            BRANCH_SLUG="$(printf '%s' '${{ github.ref_name }}' | tr '/' '-')"
            RELEASE_ID="${BRANCH_SLUG}-${{ github.run_number }}-${SHORT_SHA}"
            RELEASE_DIR="${RELEASES_DIR}/${RELEASE_ID}"
            # Use a relative symlink target so it resolves correctly both on host
            # (/opt/caddy/www/html) and inside the Caddy container (/var/www/html).
            RELEASE_LINK_TARGET="releases/${RELEASE_ID}"
            TMP_LINK="${DEPLOY_BASE}/.current_tmp"

            if [ ! -d "$STAGING_DIR" ]; then
              echo "âŒ Staging directory not found: $STAGING_DIR"
              exit 1
            fi

            sudo mkdir -p "$RELEASES_DIR"
            sudo mkdir -p "$RELEASE_DIR"
            sudo cp -a "$STAGING_DIR"/. "$RELEASE_DIR"/

            sudo rm -f "$TMP_LINK"
            sudo ln -s "$RELEASE_LINK_TARGET" "$TMP_LINK"
            sudo mv -Tf "$TMP_LINK" "$CURRENT_LINK"

            rm -rf "$STAGING_DIR"

            # ìµœê·¼ 5ê°œ ë¦´ë¦¬ì¦ˆë§Œ ìœ ì§€
            (sudo ls -1dt "$RELEASES_DIR"/* 2>/dev/null || true) | tail -n +6 | xargs -r sudo rm -rf

            echo "âœ… Deployed release: $RELEASE_DIR"
            echo "âœ… Current link -> $(readlink "$CURRENT_LINK")"
            if [ -f "$CURRENT_LINK/version.txt" ]; then
              echo "--- version.txt ---"
              cat "$CURRENT_LINK/version.txt"
            fi

      # 4. ì‹¤íŒ¨/ì¤‘ë‹¨ í¬í•¨ staging ì”ì—¬ë¬¼ ì •ë¦¬
      - name: Cleanup Staging Directory
        if: always()
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          script: |
            rm -rf "/home/${{ secrets.USERNAME }}/frontend/staging/${{ github.ref_name }}/${{ github.run_number }}"

      # 5. ë°°í¬ ê²°ê³¼ ì•Œë¦¼ (Discord)
      - name: Notify Deployment Result
        if: always()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "í”„ë¡ íŠ¸ì—”ë“œ ${{ github.ref_name == 'main' && 'ìš´ì˜' || 'ê°œë°œ' }} ì„œë²„ ë°°í¬ ${{ job.status == 'success' && 'ì„±ê³µ ğŸ’—' || 'ì‹¤íŒ¨ ğŸ’”ğŸ’€' }}"
          description: |
            **ê²°ê³¼:** ${{ job.status }}
            **ë¸Œëœì¹˜:** ${{ github.ref_name }}
            **Run Number:** ${{ github.run_number }}
            **ì‘ì„±ì:** ${{ github.actor }}
            **ì»¤ë°‹:** ${{ github.sha }}
            **ì„œë²„ í™˜ê²½:** ${{ github.ref_name == 'main' && 'ìš´ì˜' || 'ê°œë°œ' }} ì„œë²„
          color: ${{ job.status == 'success' && '0x00ff00' || '0xff0000' }}
