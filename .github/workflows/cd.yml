name: Frontend CD

on:
  push:
    branches:
      - develop
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: ${{ github.ref_name == 'main' && 'production' || 'development' }}

    steps:
      # 1. ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout source code
        uses: actions/checkout@v4

      # 2. Node.js ì„¤ì •
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      # 3. ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies
        run: npm ci

      # 4. ë¹Œë“œ
      - name: Build
        env:
          VITE_APP_ENV: ${{ secrets.VITE_APP_ENV }}
          VITE_APP_URL: ${{ secrets.VITE_APP_URL }}
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}
        run: npm run build

      # 5. ë¹Œë“œ ì‚°ì¶œë¬¼ ì—…ë¡œë“œ (run_number ê¸°ë°˜ - ë¡¤ë°±ìš©)
      - name: Upload Build Artifact (with run number)
        uses: actions/upload-artifact@v4
        with:
          name: fe-${{ github.ref_name }}-${{ github.run_number }}
          path: dist/
          retention-days: 7

      # 6. ë¹Œë“œ ì‚°ì¶œë¬¼ ì—…ë¡œë“œ (latest - ë°°í¬ìš©)
      - name: Upload Build Artifact (latest)
        uses: actions/upload-artifact@v4
        with:
          name: fe-${{ github.ref_name }}-latest
          path: dist/
          retention-days: 7

      # 8. ë¹Œë“œ ìš”ì•½
      - name: Build Summary
        run: |
          echo "### Build Success :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.ref_name == 'main' && 'ìš´ì˜' || 'ê°œë°œ' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Artifact Name:** \`fe-${{ github.ref_name }}-${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Run Number:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "You can rollback to this version using the Rollback workflow." >> $GITHUB_STEP_SUMMARY

      # 9. ë¹Œë“œ ì‹¤íŒ¨ ì•Œë¦¼
      - name: Notify Build Failure
        if: failure()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "í”„ë¡ íŠ¸ì—”ë“œ ${{ github.ref_name == 'main' && 'ìš´ì˜' || 'ê°œë°œ' }} ì„œë²„ ë¹Œë“œ ì‹¤íŒ¨ ğŸ’”"
          description: |
            **ê²°ê³¼:** ë¹Œë“œ ì‹¤íŒ¨
            **ë¸Œëœì¹˜:** ${{ github.ref_name }}
            **Run Number:** ${{ github.run_number }}
            **ì‘ì„±ì:** ${{ github.actor }}
            **ì»¤ë°‹:** ${{ github.sha }}
          color: 0xff0000

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name == 'main' && 'production' || 'development' }}

    steps:
      # 1. ë¹Œë“œ ì‚°ì¶œë¬¼ ë‹¤ìš´ë¡œë“œ
      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: fe-${{ github.ref_name }}-latest
          path: ./deploy-temp

      # 2. ì„œë²„ë¡œ ì •ì  íŒŒì¼ ì „ì†¡
      - name: Transfer Static Files to Server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          source: "./deploy-temp/*"
          target: "/home/${{ secrets.USERNAME }}/frontend/temp"
          strip_components: 1

      # 3. ì •ì  íŒŒì¼ ë°°í¬
      - name: Deploy Frontend Files
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          script: |
            TEMP_DIR="/home/${{ secrets.USERNAME }}/frontend/temp"
            WEB_ROOT="/var/www/html"

            # ê¸°ì¡´ íŒŒì¼ ì‚­ì œ ë° ìƒˆ íŒŒì¼ ë°°í¬
            rm -rf $WEB_ROOT/*
            cp -r $TEMP_DIR/* $WEB_ROOT/

            # ì„ì‹œ íŒŒì¼ ì •ë¦¬
            rm -rf $TEMP_DIR/*

      # 4. ë°°í¬ ê²°ê³¼ ì•Œë¦¼ (Discord)
      - name: Notify Deployment Result
        if: always()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "í”„ë¡ íŠ¸ì—”ë“œ ${{ github.ref_name == 'main' && 'ìš´ì˜' || 'ê°œë°œ' }} ì„œë²„ ë°°í¬ ${{ job.status == 'success' && 'ì„±ê³µ â¤ï¸' || 'ì‹¤íŒ¨ ğŸ’”ğŸ’€' }}"
          description: |
            **ê²°ê³¼:** ${{ job.status }}
            **ë¸Œëœì¹˜:** ${{ github.ref_name }}
            **Run Number:** ${{ github.run_number }}
            **ì‘ì„±ì:** ${{ github.actor }}
            **ì»¤ë°‹:** ${{ github.sha }}
            **ì„œë²„ í™˜ê²½:** ${{ github.ref_name == 'main' && 'ìš´ì˜' || 'ê°œë°œ' }} ì„œë²„
          color: ${{ job.status == 'success' && '0x00ff00' || '0xff0000' }}
